function qddot = fun_qddotsspsinglecontact(x,u,dt)
%%%% SSP phase- 1   %%%%%%%%%%%%%%


global A B Nx Nu pert MI L m  nx ny tx ty g r lam vars misc alp alpval indic kc lamall xdata lamx lamy val af acal fx fy Mmat2


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
m1 = m(1);
m2 = m(2);
m3 = m(3);
m4 = m(4);
m5 = m(5);
m6 = m(6);
m7 = m(7);

%L1 = L(1);
L2 = L(1);
L3 = L(2);
%L4 = L(4);
L5 = L(3);
L6 = L(4);

%r1 = ra(1);% trunk
r2 = r(1);
r3 = r(2);
%r4 = ra(4);
r5 = r(3);
r6 = r(4);
%r7 = ra(7);

MI1 = MI(1);
MI2 = MI(2);
MI3 = MI(3);
MI4 = MI(4);
MI5 = MI(5);
MI6 = MI(6);
MI7 = MI(7);
R2 = misc(1);
R3 = misc(2);
%R2 = 0.4028;
%R3 = 0.4061;
del2 = misc(3);
del3 = misc(4);
%del2 = deg2rad(1.142);
%del3 = deg2rad(1.20);
gamma61 = misc(5);
gamma62 = misc(6);
gamma71 = misc(7);
gamma72 = misc(8);
r4 = vars(1);
r7 = vars(2);
r4t = vars(3);
r4h = vars(4);

%M= 0;
d1 = 0.1081;
d3 = 0.0682;
h4 = 0.0437;
h2 = 0.0722;
r4c =  vars(5)   %0.1638;
% 0.0872 new value considering lycop = 0
gamma43 =  vars(6) % 2.3752 ;  
% 2.6481 new value considering lycop = 0


%{
tht1 = xdata(1);
tht2 = xdata(2);
tht3 = xdata(3);
tht4 = xdata(4);
tht5 = xdata(5);
tht6 = xdata(6);
tht7 = xdata(7);
x1   = xdata(8);
y1   = xdata(9);
omg1 = xdata(10);
omg2 = xdata(11);
omg3 = xdata(12);
omg4 = xdata(13);
omg5 = xdata(14);
omg6 = xdata(15);
omg7 = xdata(16);
vhx = xdata(17);
vhy = xdata(18);

%}

tht1 = x(3);
tht2 = x(4);
tht3 = x(5);
tht4 = x(6);
tht5 = x(7);
tht6 = x(8);
tht7 = x(9);
x1   = x(1);
y1   = x(2);
omg1 = x(12);
omg2 = x(13);
omg3 = x(14);
omg4 = x(15);
omg5 = x(16);
omg6 = x(17);
omg7 = x(18);
vhx = x(10);
vhy = x(11);

%{
alp1 = alp(3);
alp2 = alp(4);
alp3 = alp(5);
alp4 = alp(6);
alp5 = alp(7);
alp6 = alp(8);
alp7 = alp(9);
ax1 =  alp(1);
ay1 =  alp(2);
%}
T1  =  u(1);
T2  =  u(2);
T3  =  u(3);
T4  =  u(4);
T5  =  u(5);
T6  =  u(6);
T7  =  u(7);
c = -1.6;
%T1  = u(1);
%{
T2  = c*omg2*r2 +u(1);
T3  = c*omg3*r3 +u(2);
T4  = c*omg4*r4 +u(3);
T5  = c*omg5*r5 +u(4);
T6  = c*omg6*r6 +u(5);
T7  = c*omg7*r7 +u(6);
%}
lam1 = lamy;
lam2 =lamx;
%{
T2  = -c*omg2*r2 +u(1);
T3  = -c*omg3*r3 +u(2);
T4  = -MI4*alp4  -c*omg4*r4 +u(3);
T5  = -c*omg5*r5 +u(4);
T6  = -c*omg6*r6 +u(5);
T7  = -c*omg7*r7 +u(6);

%}

%T4  =  c*omg4 ;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Finding external forces

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Mmat=[m1+m2+m3+m4+m5+m6+m7,0,(-1).*m2.*R2.*sin(del2+(-1).*tht1)+(-1).* ...
  m3.*R2.*sin(del2+(-1).*tht1)+(-1).*m4.*R2.*sin(del2+(-1).*tht1)+ ...
  m5.*R3.*sin(del3+tht1)+m6.*R3.*sin(del3+tht1)+m7.*R3.*sin(del3+ ...
  tht1),L2.*m3.*sin(tht2)+L2.*m4.*sin(tht2)+m2.*r2.*sin(tht2),L3.* ...
  m4.*sin(tht3)+m3.*r3.*sin(tht3),m4.*r4.*sin(tht4),L5.*m6.*sin( ...
  tht5)+L5.*m7.*sin(tht5)+m5.*r5.*sin(tht5),L6.*m7.*sin(tht6)+m6.* ...
  r6.*sin(tht6),m7.*r7.*sin(tht7);0,m1+m2+m3+m4+m5+m6+m7,(-1).*m2.* ...
  R2.*cos(del2+(-1).*tht1)+(-1).*m3.*R2.*cos(del2+(-1).*tht1)+(-1).* ...
  m4.*R2.*cos(del2+(-1).*tht1)+(-1).*m5.*R3.*cos(del3+tht1)+(-1).* ...
  m6.*R3.*cos(del3+tht1)+(-1).*m7.*R3.*cos(del3+tht1),(-1).*L2.*m3.* ...
  cos(tht2)+(-1).*L2.*m4.*cos(tht2)+(-1).*m2.*r2.*cos(tht2),(-1).* ...
  L3.*m4.*cos(tht3)+(-1).*m3.*r3.*cos(tht3),(-1).*m4.*r4.*cos(tht4), ...
  (-1).*L5.*m6.*cos(tht5)+(-1).*L5.*m7.*cos(tht5)+(-1).*m5.*r5.*cos( ...
  tht5),(-1).*L6.*m7.*cos(tht6)+(-1).*m6.*r6.*cos(tht6),(-1).*m7.* ...
  r7.*cos(tht7);(-1).*m2.*R2.*sin(del2+(-1).*tht1)+(-1).*m3.*R2.* ...
  sin(del2+(-1).*tht1)+(-1).*m4.*R2.*sin(del2+(-1).*tht1)+m5.*R3.* ...
  sin(del3+tht1)+m6.*R3.*sin(del3+tht1)+m7.*R3.*sin(del3+tht1),(-1) ...
  .*m2.*R2.*cos(del2+(-1).*tht1)+(-1).*m3.*R2.*cos(del2+(-1).*tht1)+ ...
  (-1).*m4.*R2.*cos(del2+(-1).*tht1)+(-1).*m5.*R3.*cos(del3+tht1)+( ...
  -1).*m6.*R3.*cos(del3+tht1)+(-1).*m7.*R3.*cos(del3+tht1),MI1+m2.* ...
  R2.^2+m3.*R2.^2+m4.*R2.^2+m5.*R3.^2+m6.*R3.^2+m7.*R3.^2,L2.*m3.* ...
  R2.*cos(del2+(-1).*tht1+tht2)+L2.*m4.*R2.*cos(del2+(-1).*tht1+ ...
  tht2)+m2.*r2.*R2.*cos(del2+(-1).*tht1+tht2),L3.*m4.*R2.*cos(del2+( ...
  -1).*tht1+tht3)+m3.*R2.*r3.*cos(del2+(-1).*tht1+tht3),m4.*R2.*r4.* ...
  cos(del2+(-1).*tht1+tht4),L5.*m6.*R3.*cos(del3+tht1+(-1).*tht5)+ ...
  L5.*m7.*R3.*cos(del3+tht1+(-1).*tht5)+m5.*R3.*r5.*cos(del3+tht1+( ...
  -1).*tht5),L6.*m7.*R3.*cos(del3+tht1+(-1).*tht6)+m6.*R3.*r6.*cos( ...
  del3+tht1+(-1).*tht6),m7.*R3.*r7.*cos(del3+tht1+(-1).*tht7);L2.* ...
  m3.*sin(tht2)+L2.*m4.*sin(tht2)+m2.*r2.*sin(tht2),(-1).*L2.*m3.* ...
  cos(tht2)+(-1).*L2.*m4.*cos(tht2)+(-1).*m2.*r2.*cos(tht2),L2.*m3.* ...
  R2.*cos(del2+(-1).*tht1+tht2)+L2.*m4.*R2.*cos(del2+(-1).*tht1+ ...
  tht2)+m2.*r2.*R2.*cos(del2+(-1).*tht1+tht2),L2.^2.*(m3+m4)+MI2+ ...
  m2.*r2.^2,L2.*L3.*m4.*cos(tht2+(-1).*tht3)+L2.*m3.*r3.*cos(tht2+( ...
  -1).*tht3),L2.*m4.*r4.*cos(tht2+(-1).*tht4),0,0,0;L3.*m4.*sin( ...
  tht3)+m3.*r3.*sin(tht3),(-1).*L3.*m4.*cos(tht3)+(-1).*m3.*r3.*cos( ...
  tht3),L3.*m4.*R2.*cos(del2+(-1).*tht1+tht3)+m3.*R2.*r3.*cos(del2+( ...
  -1).*tht1+tht3),L2.*L3.*m4.*cos(tht2+(-1).*tht3)+L2.*m3.*r3.*cos( ...
  tht2+(-1).*tht3),L3.^2.*m4+MI3+m3.*r3.^2,L3.*m4.*r4.*cos(tht3+(-1) ...
  .*tht4),0,0,0;m4.*r4.*sin(tht4),(-1).*m4.*r4.*cos(tht4),m4.*R2.* ...
  r4.*cos(del2+(-1).*tht1+tht4),L2.*m4.*r4.*cos(tht2+(-1).*tht4), ...
  L3.*m4.*r4.*cos(tht3+(-1).*tht4),MI4+m4.*r4.^2,0,0,0;L5.*m6.*sin( ...
  tht5)+L5.*m7.*sin(tht5)+m5.*r5.*sin(tht5),(-1).*L5.*m6.*cos(tht5)+ ...
  (-1).*L5.*m7.*cos(tht5)+(-1).*m5.*r5.*cos(tht5),L5.*m6.*R3.*cos( ...
  del3+tht1+(-1).*tht5)+L5.*m7.*R3.*cos(del3+tht1+(-1).*tht5)+m5.* ...
  R3.*r5.*cos(del3+tht1+(-1).*tht5),0,0,0,L5.^2.*(m6+m7)+MI5+m5.* ...
  r5.^2,L5.*L6.*m7.*cos(tht5+(-1).*tht6)+L5.*m6.*r6.*cos(tht5+(-1).* ...
  tht6),L5.*m7.*r7.*cos(tht5+(-1).*tht7);L6.*m7.*sin(tht6)+m6.*r6.* ...
  sin(tht6),(-1).*L6.*m7.*cos(tht6)+(-1).*m6.*r6.*cos(tht6),L6.*m7.* ...
  R3.*cos(del3+tht1+(-1).*tht6)+m6.*R3.*r6.*cos(del3+tht1+(-1).* ...
  tht6),0,0,0,L5.*L6.*m7.*cos(tht5+(-1).*tht6)+L5.*m6.*r6.*cos(tht5+ ...
  (-1).*tht6),L6.^2.*m7+MI6+m6.*r6.^2,L6.*m7.*r7.*cos(tht6+(-1).* ...
  tht7);m7.*r7.*sin(tht7),(-1).*m7.*r7.*cos(tht7),m7.*R3.*r7.*cos( ...
  del3+tht1+(-1).*tht7),0,0,0,L5.*m7.*r7.*cos(tht5+(-1).*tht7),L6.* ...
  m7.*r7.*cos(tht6+(-1).*tht7),MI7+m7.*r7.^2]



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

eig(Mmat)
issymmetric(Mmat)



%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% phi is for finding qddot with ext lambda calculation 
phi=[(-1).*m2.*omg1.^2.*R2.*cos(del2+(-1).*tht1)+(-1).*m3.*omg1.^2.* ...
  R2.*cos(del2+(-1).*tht1)+(-1).*m4.*omg1.^2.*R2.*cos(del2+(-1).* ...
  tht1)+(-1).*m5.*omg1.^2.*R3.*cos(del3+tht1)+(-1).*m6.*omg1.^2.* ...
  R3.*cos(del3+tht1)+(-1).*m7.*omg1.^2.*R3.*cos(del3+tht1)+(-1).* ...
  L2.*m3.*omg2.^2.*cos(tht2)+(-1).*L2.*m4.*omg2.^2.*cos(tht2)+(-1).* ...
  m2.*omg2.^2.*r2.*cos(tht2)+(-1).*L3.*m4.*omg3.^2.*cos(tht3)+(-1).* ...
  m3.*omg3.^2.*r3.*cos(tht3)+(-1).*m4.*omg4.^2.*r4.*cos(tht4)+(-1).* ...
  L5.*m6.*omg5.^2.*cos(tht5)+(-1).*L5.*m7.*omg5.^2.*cos(tht5)+(-1).* ...
  m5.*omg5.^2.*r5.*cos(tht5)+(-1).*L6.*m7.*omg6.^2.*cos(tht6)+(-1).* ...
  m6.*omg6.^2.*r6.*cos(tht6)+(-1).*m7.*omg7.^2.*r7.*cos(tht7),(-1).* ...
  g.*m1+(-1).*g.*m2+(-1).*g.*m3+(-1).*g.*m4+(-1).*g.*m5+(-1).*g.*m6+ ...
  (-1).*g.*m7+m2.*omg1.^2.*R2.*sin(del2+(-1).*tht1)+m3.*omg1.^2.* ...
  R2.*sin(del2+(-1).*tht1)+m4.*omg1.^2.*R2.*sin(del2+(-1).*tht1)+( ...
  -1).*m5.*omg1.^2.*R3.*sin(del3+tht1)+(-1).*m6.*omg1.^2.*R3.*sin( ...
  del3+tht1)+(-1).*m7.*omg1.^2.*R3.*sin(del3+tht1)+(-1).*L2.*m3.* ...
  omg2.^2.*sin(tht2)+(-1).*L2.*m4.*omg2.^2.*sin(tht2)+(-1).*m2.* ...
  omg2.^2.*r2.*sin(tht2)+(-1).*L3.*m4.*omg3.^2.*sin(tht3)+(-1).*m3.* ...
  omg3.^2.*r3.*sin(tht3)+(-1).*m4.*omg4.^2.*r4.*sin(tht4)+(-1).*L5.* ...
  m6.*omg5.^2.*sin(tht5)+(-1).*L5.*m7.*omg5.^2.*sin(tht5)+(-1).*m5.* ...
  omg5.^2.*r5.*sin(tht5)+(-1).*L6.*m7.*omg6.^2.*sin(tht6)+(-1).*m6.* ...
  omg6.^2.*r6.*sin(tht6)+(-1).*m7.*omg7.^2.*r7.*sin(tht7),T1+(-1).* ...
  T2+(-1).*T5+g.*m2.*R2.*cos(del2+(-1).*tht1)+g.*m3.*R2.*cos(del2+( ...
  -1).*tht1)+g.*m4.*R2.*cos(del2+(-1).*tht1)+g.*m5.*R3.*cos(del3+ ...
  tht1)+g.*m6.*R3.*cos(del3+tht1)+g.*m7.*R3.*cos(del3+tht1)+L2.*m3.* ...
  omg2.^2.*R2.*sin(del2+(-1).*tht1+tht2)+L2.*m4.*omg2.^2.*R2.*sin( ...
  del2+(-1).*tht1+tht2)+m2.*omg2.^2.*r2.*R2.*sin(del2+(-1).*tht1+ ...
  tht2)+L3.*m4.*omg3.^2.*R2.*sin(del2+(-1).*tht1+tht3)+m3.*omg3.^2.* ...
  R2.*r3.*sin(del2+(-1).*tht1+tht3)+m4.*omg4.^2.*R2.*r4.*sin(del2+( ...
  -1).*tht1+tht4)+(-1).*L5.*m6.*omg5.^2.*R3.*sin(del3+tht1+(-1).* ...
  tht5)+(-1).*L5.*m7.*omg5.^2.*R3.*sin(del3+tht1+(-1).*tht5)+(-1).* ...
  m5.*omg5.^2.*R3.*r5.*sin(del3+tht1+(-1).*tht5)+(-1).*L6.*m7.* ...
  omg6.^2.*R3.*sin(del3+tht1+(-1).*tht6)+(-1).*m6.*omg6.^2.*R3.*r6.* ...
  sin(del3+tht1+(-1).*tht6)+(-1).*m7.*omg7.^2.*R3.*r7.*sin(del3+ ...
  tht1+(-1).*tht7),T2+(-1).*T3+g.*L2.*m3.*cos(tht2)+g.*L2.*m4.*cos( ...
  tht2)+g.*m2.*r2.*cos(tht2)+(-1).*L2.*m3.*omg1.^2.*R2.*sin(del2+( ...
  -1).*tht1+tht2)+(-1).*L2.*m4.*omg1.^2.*R2.*sin(del2+(-1).*tht1+ ...
  tht2)+(-1).*m2.*omg1.^2.*r2.*R2.*sin(del2+(-1).*tht1+tht2)+(-1).* ...
  L2.*L3.*m4.*omg3.^2.*sin(tht2+(-1).*tht3)+(-1).*L2.*m3.*omg3.^2.* ...
  r3.*sin(tht2+(-1).*tht3)+(-1).*L2.*m4.*omg4.^2.*r4.*sin(tht2+(-1) ...
  .*tht4),T3+(-1).*T4+g.*L3.*m4.*cos(tht3)+g.*m3.*r3.*cos(tht3)+L2.* ...
  L3.*m4.*omg2.^2.*sin(tht2+(-1).*tht3)+L2.*m3.*omg2.^2.*r3.*sin( ...
  tht2+(-1).*tht3)+(-1).*L3.*m4.*omg1.^2.*R2.*sin(del2+(-1).*tht1+ ...
  tht3)+(-1).*m3.*omg1.^2.*R2.*r3.*sin(del2+(-1).*tht1+tht3)+(-1).* ...
  L3.*m4.*omg4.^2.*r4.*sin(tht3+(-1).*tht4),T4+g.*m4.*r4.*cos(tht4)+ ...
  L2.*m4.*omg2.^2.*r4.*sin(tht2+(-1).*tht4)+L3.*m4.*omg3.^2.*r4.* ...
  sin(tht3+(-1).*tht4)+(-1).*m4.*omg1.^2.*R2.*r4.*sin(del2+(-1).* ...
  tht1+tht4),T5+(-1).*T6+g.*L5.*m6.*cos(tht5)+g.*L5.*m7.*cos(tht5)+ ...
  g.*m5.*r5.*cos(tht5)+L5.*m6.*omg1.^2.*R3.*sin(del3+tht1+(-1).* ...
  tht5)+L5.*m7.*omg1.^2.*R3.*sin(del3+tht1+(-1).*tht5)+m5.*omg1.^2.* ...
  R3.*r5.*sin(del3+tht1+(-1).*tht5)+(-1).*L5.*L6.*m7.*omg6.^2.*sin( ...
  tht5+(-1).*tht6)+(-1).*L5.*m6.*omg6.^2.*r6.*sin(tht5+(-1).*tht6)+( ...
  -1).*L5.*m7.*omg7.^2.*r7.*sin(tht5+(-1).*tht7),T6+(-1).*T7+g.*L6.* ...
  m7.*cos(tht6)+g.*m6.*r6.*cos(tht6)+L6.*m7.*omg1.^2.*R3.*sin(del3+ ...
  tht1+(-1).*tht6)+m6.*omg1.^2.*R3.*r6.*sin(del3+tht1+(-1).*tht6)+ ...
  L5.*L6.*m7.*omg5.^2.*sin(tht5+(-1).*tht6)+L5.*m6.*omg5.^2.*r6.* ...
  sin(tht5+(-1).*tht6)+(-1).*L6.*m7.*omg7.^2.*r7.*sin(tht6+(-1).* ...
  tht7),T7+g.*m7.*r7.*cos(tht7)+m7.*omg1.^2.*R3.*r7.*sin(del3+tht1+( ...
  -1).*tht7)+L5.*m7.*omg5.^2.*r7.*sin(tht5+(-1).*tht7)+L6.*m7.* ...
  omg6.^2.*r7.*sin(tht6+(-1).*tht7)]







%{
%%%%%%%%%%%%%%%%%%%%%%%
inv(Mmat);
qddot = Mmat\phi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%rhs1 = rhs;
%Cn  = Cmat;
%rhs2 = Gd';


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%rhs2 -gn
%%rhs1 - phi
%Mmat
invM = inv(Mmat)

%Gmat = Cn*invM*Cn';
%invG = inv(Gmat);

%nr  = Gd' - Cn*invM*rhs1';
%P1 = Gd' ;
%P2 = Cn*invM*rhs1';
%lam = Gmat\( Gd'- Cn*invM*rhs1')

%lam = [lam1;lam2;lam3;lam4]
%(Cn'*lam + rhs1')
%qddot_invdy = invM*(Cn'*lam + rhs1');
%}

% qddot = qddot_invdy

phi;
qddot_invdy = invM*phi'
%qddot_invdy(4) = 0
af =qddot_invdy ;
%qddot = [omg1;omg2;omg3;omg4;omg5;omg6;omg7;vhx;vhy;qddot_invdy]
 qddot = qddot_invdy;
 %lamx = lam2 + lam4;
 %lamy = lam1 + lam3;
% lamx = lamt;
% lamy = lamn;

end






 






